name: Build RPM Packages

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v2.0.0, v2.1.0, etc.

jobs:
  build-rhel9:
    name: Build RPM for RHEL 9
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
    
    steps:
      - name: Install build dependencies
        run: |
          dnf install -y epel-release
          dnf install -y rpm-build python3-devel python3-pip python3-setuptools git make selinux-policy-devel \
            systemd firewalld

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git safe directory
        run: |
          git config --global --add safe.directory /__w/tuxsec/tuxsec

      - name: Get version from tag
        id: version
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update version in spec file
        run: |
          sed -i "s/^Version:.*/Version:        ${{ steps.version.outputs.version }}/" tuxsec-agent.spec

      - name: Build RPMs
        run: |
          make rpm

      - name: Build SELinux policy
        run: |
          make selinux

      - name: List built packages
        run: |
          echo "=== noarch packages ==="
          ls -lh build/rpmbuild/RPMS/noarch/ || echo "No noarch packages"
          echo "=== x86_64 packages ==="
          ls -lh build/rpmbuild/RPMS/x86_64/ || echo "No x86_64 packages"
          echo "=== Source packages ==="
          ls -lh build/rpmbuild/SRPMS/ || echo "No source packages"

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpms-rhel9
          path: |
            build/rpmbuild/RPMS/noarch/*.rpm
            build/rpmbuild/RPMS/x86_64/*.rpm
            build/rpmbuild/SRPMS/*.rpm
          retention-days: 90

  build-rhel10:
    name: Build RPM for RHEL 10
    runs-on: ubuntu-latest
    container:
      image: quay.io/centos/centos:stream10-development
    
    steps:
      - name: Install build dependencies
        run: |
          dnf install -y epel-release || true
          dnf install -y rpm-build python3-devel python3-pip python3-setuptools git make selinux-policy-devel \
            systemd firewalld

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git safe directory
        run: |
          git config --global --add safe.directory /__w/tuxsec/tuxsec

      - name: Get version from tag
        id: version
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update version in spec file
        run: |
          sed -i "s/^Version:.*/Version:        ${{ steps.version.outputs.version }}/" tuxsec-agent.spec

      - name: Build RPMs
        run: |
          make rpm

      - name: Build SELinux policy
        run: |
          make selinux

      - name: List built packages
        run: |
          echo "=== noarch packages ==="
          ls -lh build/rpmbuild/RPMS/noarch/ || echo "No noarch packages"
          echo "=== x86_64 packages ==="
          ls -lh build/rpmbuild/RPMS/x86_64/ || echo "No x86_64 packages"
          echo "=== Source packages ==="
          ls -lh build/rpmbuild/SRPMS/ || echo "No source packages"

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpms-rhel10
          path: |
            build/rpmbuild/RPMS/noarch/*.rpm
            build/rpmbuild/RPMS/x86_64/*.rpm
            build/rpmbuild/SRPMS/*.rpm
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build-rhel9, build-rhel10]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download RHEL 9 RPMs
        uses: actions/download-artifact@v4
        with:
          name: rpms-rhel9
          path: ./release/rhel9

      - name: Download RHEL 10 RPMs
        uses: actions/download-artifact@v4
        with:
          name: rpms-rhel10
          path: ./release/rhel10

      - name: Organize release files
        run: |
          mkdir -p release-files
          
          # Debug: show what we have
          echo "=== Downloaded artifacts structure ==="
          find release -type f -ls
          echo "======================================"
          
          # RHEL 9 RPMs
          echo "Processing RHEL 9 RPMs..."
          find release/rhel9 -name "*.rpm" -type f | while read rpm; do
            echo "Found: $rpm"
            cp "$rpm" release-files/ && echo "Copied: $(basename $rpm)"
          done
          
          # RHEL 10 RPMs - rename to include .el10 if not already present
          echo "Processing RHEL 10 RPMs..."
          find release/rhel10 -name "*.rpm" -type f | while read rpm; do
            base=$(basename "$rpm")
            echo "Found: $rpm"
            
            # Check if .el10 is already in the filename
            if [[ "$base" == *".el10."* ]]; then
              # Already has .el10, just copy as-is
              newname="$base"
            elif [[ "$base" == *.noarch.rpm ]]; then
              # Insert .el10 before .noarch.rpm
              newname=$(echo "$base" | sed 's/\.noarch\.rpm$/.el10.noarch.rpm/')
            elif [[ "$base" == *.x86_64.rpm ]]; then
              # Insert .el10 before .x86_64.rpm
              newname=$(echo "$base" | sed 's/\.x86_64\.rpm$/.el10.x86_64.rpm/')
            elif [[ "$base" == *.src.rpm ]]; then
              # Insert .el10 before .src.rpm
              newname=$(echo "$base" | sed 's/\.src\.rpm$/.el10.src.rpm/')
            else
              newname="$base"
            fi
            cp "$rpm" "release-files/$newname" && echo "Copied: $newname"
          done
          
          echo ""
          echo "=== Release files ==="
          ls -lh release-files/
          echo "====================="
          echo ""
          echo "=== File count ==="
          echo "RPMs: $(find release-files -name "*.rpm" | wc -l)"
          echo "=================="

      - name: Generate checksums
        run: |
          cd release-files
          # Check if any RPM files exist
          if ls *.rpm 1> /dev/null 2>&1; then
            sha256sum *.rpm > SHA256SUMS
            echo "=== Checksums ==="
            cat SHA256SUMS
            echo "================="
          else
            echo "ERROR: No RPM files found to checksum!"
            echo "Files in release-files/:"
            ls -la
            exit 1
          fi

      - name: Create release notes
        run: |
          cat > release-notes.md <<'EOF'
          # TuxSec Agent ${{ steps.version.outputs.version }}

          ## Installation

          ### RHEL 9 / Rocky Linux 9 / AlmaLinux 9
          ```bash
          # Download RPMs
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/tuxsec-agent-${{ steps.version.outputs.version }}-1.el9.noarch.rpm
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/tuxsec-agent-firewalld-${{ steps.version.outputs.version }}-1.el9.noarch.rpm
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/tuxsec-agent-selinux-${{ steps.version.outputs.version }}-1.el9.noarch.rpm

          # Install
          sudo dnf install tuxsec-agent-*.el9.noarch.rpm

          # Configure
          sudo tuxsec-setup
          ```

          ### RHEL 10 / Rocky Linux 10 / AlmaLinux 10
          ```bash
          # Download RPMs
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/tuxsec-agent-${{ steps.version.outputs.version }}-1.el10.noarch.rpm
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/tuxsec-agent-firewalld-${{ steps.version.outputs.version }}-1.el10.noarch.rpm
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/tuxsec-agent-selinux-${{ steps.version.outputs.version }}-1.el10.noarch.rpm

          # Install
          sudo dnf install tuxsec-agent-*.el10.noarch.rpm

          # Configure
          sudo tuxsec-setup
          ```

          ## Packages

          - **tuxsec-agent** - Base package (daemon, agent, CLI, setup wizard)
          - **tuxsec-agent-firewalld** - Firewall management module
          - **tuxsec-agent-selinux** - SELinux policy module

          ## What's New

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for detailed changes.

          ## Documentation

          - [README](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)
          - [Agent Documentation](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/agent/README.md)
          - [Architecture](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/agent/ARCHITECTURE.md)
          - [Packaging Guide](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/PACKAGING.md)
          - [Quick Reference](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/QUICKREF.md)

          ## Verification

          All packages include SHA256 checksums in the `SHA256SUMS` file.

          ```bash
          # Verify checksums
          sha256sum -c SHA256SUMS
          ```
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: |
            release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
